<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IEC Dashboard</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
:root {
  --bg:#0d1117; --surface:#161b22; --surface2:#1c2128; --border:#30363d;
  --text:#e6edf3; --text2:#8b949e; --accent:#58a6ff; --green:#3fb950;
  --yellow:#d29922; --red:#f85149; --purple:#bc8cff; --orange:#f0883e;
}
body { background:var(--bg); color:var(--text); font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif; height:100vh; display:flex; flex-direction:column; overflow:hidden; }

/* â”€â”€ Header â”€â”€ */
header { background:var(--surface); border-bottom:1px solid var(--border); padding:12px 20px; display:flex; align-items:center; justify-content:space-between; flex-shrink:0; }
header h1 { font-size:16px; font-weight:700; letter-spacing:-0.3px; }
header h1 span { color:var(--accent); }
.hdr-right { display:flex; align-items:center; gap:10px; }
.ws-dot { width:7px; height:7px; border-radius:50%; background:var(--red); transition:background .3s; }
.ws-dot.on { background:var(--green); }
.ws-lbl { font-size:11px; color:var(--text2); }

/* â”€â”€ Tabs â”€â”€ */
.tabs { background:var(--surface); border-bottom:1px solid var(--border); display:flex; padding:0 20px; gap:2px; flex-shrink:0; }
.tab { padding:10px 16px; font-size:13px; cursor:pointer; border-bottom:2px solid transparent; color:var(--text2); transition:all .15s; user-select:none; }
.tab:hover { color:var(--text); }
.tab.active { color:var(--accent); border-bottom-color:var(--accent); }

/* â”€â”€ Layout â”€â”€ */
.main { display:flex; flex:1; overflow:hidden; min-height:0; }
.content { flex:1; overflow-y:auto; padding:16px 20px; }
.page { display:none; }
.page.active { display:block; }

/* â”€â”€ Buttons â”€â”€ */
.btn { background:var(--accent); color:#000; border:none; padding:5px 13px; border-radius:6px; font-size:12px; font-weight:600; cursor:pointer; transition:opacity .15s; }
.btn:hover { opacity:.85; }
.btn.sec { background:var(--surface2); color:var(--text); border:1px solid var(--border); font-weight:400; }
.btn.ghost { background:transparent; color:var(--text2); border:1px solid var(--border); font-weight:400; }
.btn.ghost:hover { color:var(--text); }
.btn.sm { padding:3px 9px; font-size:11px; }
.btn.danger { background:var(--red); color:#fff; }

/* â”€â”€ Stats bar â”€â”€ */
.stats { display:flex; gap:10px; margin-bottom:14px; flex-wrap:wrap; }
.stat { background:var(--surface); border:1px solid var(--border); border-radius:8px; padding:8px 14px; }
.stat .num { font-size:20px; font-weight:700; color:var(--accent); }
.stat .lbl { font-size:11px; color:var(--text2); margin-top:1px; }

/* â”€â”€ Kanban â”€â”€ */
.toolbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:14px; }
.filter-btn { background:var(--surface2); border:1px solid var(--border); color:var(--text2); padding:4px 10px; border-radius:6px; font-size:12px; cursor:pointer; transition:all .15s; }
.filter-btn:hover,.filter-btn.active { border-color:var(--accent); color:var(--accent); background:rgba(88,166,255,.1); }
.board { display:grid; grid-template-columns:repeat(3,1fr); gap:14px; }
.col { background:var(--surface); border:1px solid var(--border); border-radius:10px; overflow:hidden; }
.col-hdr { padding:10px 14px; font-size:13px; font-weight:600; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--border); }
.col-title { display:flex; align-items:center; gap:7px; }
.col-dot { width:7px; height:7px; border-radius:50%; }
.badge { background:var(--surface2); border:1px solid var(--border); color:var(--text2); font-size:11px; padding:1px 6px; border-radius:10px; }
.cards { padding:8px; min-height:80px; display:flex; flex-direction:column; gap:7px; }
.card { background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:10px; cursor:pointer; transition:border-color .15s,transform .1s; position:relative; }
.card:hover { border-color:var(--accent); transform:translateY(-1px); }
.card-title { font-size:13px; font-weight:500; margin-bottom:5px; line-height:1.4; padding-right:48px; }
.card-desc { font-size:12px; color:var(--text2); margin-bottom:7px; line-height:1.4; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
.card-meta { display:flex; gap:5px; flex-wrap:wrap; align-items:center; }
.tag { font-size:11px; padding:1px 6px; border-radius:10px; border:1px solid; }
.p-high { color:var(--red); border-color:rgba(248,81,73,.4); background:rgba(248,81,73,.1); }
.p-medium { color:var(--yellow); border-color:rgba(210,153,34,.4); background:rgba(210,153,34,.1); }
.p-low { color:var(--green); border-color:rgba(63,185,80,.4); background:rgba(63,185,80,.1); }
.t-project { color:var(--purple); border-color:rgba(188,140,255,.4); background:rgba(188,140,255,.1); }
.t-due { color:var(--text2); border-color:var(--border); background:var(--surface); }
.t-due.ov { color:var(--red); border-color:rgba(248,81,73,.4); }
.card-actions { position:absolute; top:7px; right:7px; display:none; gap:3px; }
.card:hover .card-actions { display:flex; }
.icon-btn { background:var(--surface); border:1px solid var(--border); color:var(--text2); width:22px; height:22px; border-radius:4px; font-size:11px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all .15s; }
.icon-btn:hover { color:var(--text); border-color:var(--accent); }
.icon-btn.del:hover { color:var(--red); border-color:var(--red); }
.empty { text-align:center; padding:20px; color:var(--text2); font-size:12px; }

/* â”€â”€ Config page â”€â”€ */
.config-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:14px; }
.card-block { background:var(--surface); border:1px solid var(--border); border-radius:10px; padding:16px; }
.card-block h3 { font-size:13px; font-weight:600; margin-bottom:12px; display:flex; align-items:center; gap:6px; color:var(--text2); text-transform:uppercase; letter-spacing:.5px; }
.section-hdr { font-size:14px; font-weight:700; color:var(--accent); margin:0 0 10px 0; padding:6px 0; border-bottom:1px solid var(--border); letter-spacing:.3px; }
.kv { display:flex; flex-direction:column; gap:7px; }
.kv-row { display:flex; justify-content:space-between; align-items:center; font-size:12px; padding:6px 0; border-bottom:1px solid var(--border); }
.kv-row:last-child { border-bottom:none; }
.kv-key { color:var(--text2); }
.kv-val { color:var(--text); font-family:monospace; font-size:11px; }
.kv-val.ok { color:var(--green); }
.kv-val.warn { color:var(--yellow); }
.kv-val.err { color:var(--red); }
.session-row { background:var(--surface2); border:1px solid var(--border); border-radius:6px; padding:8px 10px; margin-bottom:7px; font-size:12px; }
.session-key { font-family:monospace; font-size:11px; color:var(--accent); margin-bottom:4px; }
.session-meta { display:flex; gap:8px; flex-wrap:wrap; color:var(--text2); }
.prog-bar { height:4px; background:var(--surface2); border-radius:2px; margin-top:4px; overflow:hidden; }
.prog-fill { height:100%; border-radius:2px; background:var(--accent); transition:width .3s; }
.prog-fill.warn { background:var(--yellow); }
.prog-fill.err { background:var(--red); }

/* â”€â”€ Files page â”€â”€ */
.files-layout { display:grid; grid-template-columns:220px 1fr; gap:14px; height:calc(100vh - 160px); }
.file-list { background:var(--surface); border:1px solid var(--border); border-radius:10px; overflow-y:auto; }
.file-list-hdr { padding:10px 14px; font-size:12px; font-weight:600; color:var(--text2); border-bottom:1px solid var(--border); text-transform:uppercase; letter-spacing:.5px; }
.file-item { padding:8px 14px; font-size:12px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); transition:background .1s; }
.file-item:last-child { border-bottom:none; }
.file-item:hover { background:var(--surface2); }
.file-item.active { background:rgba(88,166,255,.1); color:var(--accent); }
.file-name { font-weight:500; }
.file-size { color:var(--text2); font-size:11px; }
.file-section { padding:6px 14px; font-size:10px; color:var(--text2); text-transform:uppercase; letter-spacing:.5px; background:var(--surface2); border-bottom:1px solid var(--border); }
.editor-area { background:var(--surface); border:1px solid var(--border); border-radius:10px; display:flex; flex-direction:column; overflow:hidden; }
.editor-toolbar { padding:10px 14px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; }
.editor-filename { font-size:13px; font-weight:600; font-family:monospace; color:var(--accent); }
.editor-actions { display:flex; gap:8px; align-items:center; }
.edit-toggle { display:flex; gap:4px; background:var(--surface2); border:1px solid var(--border); border-radius:6px; padding:2px; }
.edit-toggle button { border:none; background:transparent; color:var(--text2); padding:3px 8px; border-radius:4px; font-size:11px; cursor:pointer; }
.edit-toggle button.active { background:var(--accent); color:#000; }
.md-view { flex:1; padding:16px 20px; overflow-y:auto; font-size:13px; line-height:1.7; }
.md-view h1 { font-size:20px; margin-bottom:12px; padding-bottom:8px; border-bottom:1px solid var(--border); }
.md-view h2 { font-size:16px; margin:16px 0 8px; color:var(--accent); }
.md-view h3 { font-size:14px; margin:12px 0 6px; color:var(--text2); }
.md-view p { margin-bottom:8px; }
.md-view code { background:var(--surface2); border:1px solid var(--border); padding:1px 5px; border-radius:3px; font-size:12px; font-family:monospace; }
.md-view pre { background:var(--surface2); border:1px solid var(--border); padding:12px; border-radius:6px; overflow-x:auto; margin-bottom:10px; }
.md-view pre code { background:none; border:none; padding:0; }
.md-view ul,.md-view ol { padding-left:20px; margin-bottom:8px; }
.md-view li { margin-bottom:3px; }
.md-view table { width:100%; border-collapse:collapse; margin-bottom:10px; font-size:12px; }
.md-view th { background:var(--surface2); padding:6px 10px; text-align:left; border:1px solid var(--border); }
.md-view td { padding:5px 10px; border:1px solid var(--border); }
.md-view strong { color:var(--text); }
.md-view a { color:var(--accent); }
.md-view blockquote { border-left:3px solid var(--border); padding-left:12px; color:var(--text2); margin-bottom:8px; }
.md-raw { flex:1; background:var(--surface2); border:none; color:var(--text); font-family:monospace; font-size:12px; line-height:1.6; padding:16px; resize:none; outline:none; }
.file-placeholder { flex:1; display:flex; align-items:center; justify-content:center; color:var(--text2); font-size:13px; }

/* â”€â”€ Chat panel â”€â”€ */
.chat-panel { width:340px; min-width:340px; border-left:1px solid var(--border); display:flex; flex-direction:column; background:var(--surface); }
.chat-panel.hidden { display:none; }
.chat-hdr { padding:11px 14px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; flex-shrink:0; }
.chat-hdr-title { font-size:13px; font-weight:600; display:flex; align-items:center; gap:7px; }
.ai-dot { width:7px; height:7px; border-radius:50%; background:var(--accent); animation:pulse 2s infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }
.chat-session-info { padding:6px 12px; border-bottom:1px solid var(--border); flex-shrink:0; font-size:11px; color:var(--text2); display:flex; align-items:center; gap:6px; }
.chat-session-info .sk { color:var(--accent); font-family:monospace; font-size:10px; flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.chat-msgs { flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column; gap:8px; }
.msg { display:flex; flex-direction:column; gap:2px; }
.msg .role { font-size:10px; color:var(--text2); text-transform:uppercase; letter-spacing:.5px; }
.msg.assistant .role { color:var(--accent); }
.msg .body { padding:7px 9px; border-radius:7px; font-size:12px; line-height:1.5; word-break:break-word; white-space:pre-wrap; }
.msg.user .body { background:rgba(88,166,255,.15); border:1px solid rgba(88,166,255,.25); }
.msg.assistant .body { background:var(--surface2); border:1px solid var(--border); }
.typing { display:flex; gap:4px; padding:7px 9px; }
.typing span { width:5px; height:5px; border-radius:50%; background:var(--text2); animation:blink 1.2s infinite; }
.typing span:nth-child(2){animation-delay:.2s}
.typing span:nth-child(3){animation-delay:.4s}
@keyframes blink{0%,80%,100%{opacity:.2}40%{opacity:1}}
.chat-input-area { padding:9px 11px; border-top:1px solid var(--border); display:flex; gap:7px; align-items:flex-end; flex-shrink:0; }
.chat-input { flex:1; background:var(--surface2); border:1px solid var(--border); color:var(--text); padding:7px 9px; border-radius:7px; font-size:12px; font-family:inherit; resize:none; outline:none; max-height:100px; overflow-y:auto; }
.chat-input:focus { border-color:var(--accent); }
.send-btn { background:var(--accent); color:#000; border:none; width:32px; height:32px; border-radius:7px; font-size:15px; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
.send-btn:hover { opacity:.85; }
.send-btn:disabled { opacity:.4; cursor:not-allowed; }

/* â”€â”€ Task Detail Panel â”€â”€ */
.detail-panel { position:fixed; right:-560px; top:0; bottom:0; width:560px; background:var(--surface); border-left:1px solid var(--border); z-index:150; transition:right .3s ease; display:flex; flex-direction:column; box-shadow:-5px 0 20px rgba(0,0,0,.5); }
.detail-panel.open { right:0; }
.detail-hdr { padding:14px 20px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; flex-shrink:0; background:var(--surface2); }
.detail-hdr h2 { font-size:15px; font-weight:700; color:var(--accent); }
.detail-body { flex:1; overflow-y:auto; padding:20px; }
.detail-section { margin-bottom:20px; }
.detail-section h3 { font-size:11px; color:var(--text2); text-transform:uppercase; letter-spacing:1px; margin-bottom:10px; border-bottom:1px solid var(--border); padding-bottom:5px; }

/* Detail Chat */
.dchat-area { display:flex; flex-direction:column; height:420px; border:1px solid var(--border); border-radius:8px; overflow:hidden; background:var(--bg); margin-top:10px; }
.dchat-msgs { flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column; gap:8px; font-size:12px; }
.dchat-input-row { padding:8px; border-top:1px solid var(--border); display:flex; flex-direction:column; gap:5px; }
.dchat-input-area { display:flex; gap:5px; align-items:flex-end; }
.dchat-input { flex:1; background:var(--surface2); border:1px solid var(--border); color:var(--text); padding:6px 10px; border-radius:6px; font-size:12px; resize:none; min-height:32px; max-height:80px; outline:none; font-family:inherit; }
.dchat-input:focus { border-color:var(--accent); }
.dchat-file-chips { display:flex; gap:4px; flex-wrap:wrap; }
.dchat-file-chip { background:rgba(88,166,255,.15); border:1px solid rgba(88,166,255,.3); color:var(--accent); font-size:10px; padding:2px 6px; border-radius:10px; display:flex; align-items:center; gap:4px; }
.dchat-file-chip button { background:none; border:none; color:var(--accent); cursor:pointer; font-size:11px; padding:0; line-height:1; }
.upload-btn { background:var(--surface2); border:1px solid var(--border); color:var(--text2); width:28px; height:28px; border-radius:6px; font-size:13px; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; transition:all .15s; }
.upload-btn:hover { border-color:var(--accent); color:var(--accent); }

/* Files in Detail */
.dfiles-list { display:flex; flex-direction:column; gap:5px; margin-top:5px; }
.dfile-item { display:flex; justify-content:space-between; align-items:center; background:var(--surface2); padding:6px 10px; border-radius:6px; font-size:12px; border:1px solid var(--border); }
.dfile-item:hover { border-color:var(--accent); }
.dfile-name { font-family:monospace; font-size:11px; color:var(--text); flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

/* Session key badge */
.sk-badge { display:inline-flex; align-items:center; gap:4px; background:rgba(88,166,255,.1); border:1px solid rgba(88,166,255,.3); border-radius:4px; padding:1px 5px; font-size:10px; font-family:monospace; color:var(--accent); margin-top:3px; max-width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

/* Context note in modal */
.context-note-fg { background:rgba(188,140,255,.05); border:1px solid rgba(188,140,255,.2); border-radius:6px; padding:10px; margin-top:4px; }
.context-note-fg label { color:var(--purple) !important; }
.context-note-fg textarea { border-color:rgba(188,140,255,.3) !important; }
.context-note-fg textarea:focus { border-color:var(--purple) !important; }

.detail-overlay { position:fixed; inset:0; background:rgba(0,0,0,.4); z-index:140; display:none; }
.detail-overlay.open { display:block; }

/* â”€â”€ Modal â”€â”€ */
.modal-bg { display:none; position:fixed; inset:0; background:rgba(0,0,0,.7); z-index:200; align-items:center; justify-content:center; }
.modal-bg.open { display:flex; }
.modal { background:var(--surface); border:1px solid var(--border); border-radius:12px; width:460px; max-width:95vw; max-height:90vh; overflow-y:auto; padding:20px; }
.modal h2 { font-size:14px; margin-bottom:16px; }
.fg { margin-bottom:11px; }
.fg label { display:block; font-size:11px; color:var(--text2); margin-bottom:4px; }
.fg input,.fg textarea,.fg select { width:100%; background:var(--surface2); border:1px solid var(--border); color:var(--text); padding:6px 9px; border-radius:6px; font-size:12px; font-family:inherit; outline:none; }
.fg input:focus,.fg textarea:focus,.fg select:focus { border-color:var(--accent); }
.fg textarea { resize:vertical; min-height:60px; }
.form-row { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.modal-actions { display:flex; gap:7px; justify-content:flex-end; margin-top:16px; }
</style>
</head>
<body>

<header>
  <h1>ğŸ— <span>IEC</span> Dashboard</h1>
  <div class="hdr-right">
    <div class="ws-dot" id="wsDot"></div>
    <span class="ws-lbl" id="wsLbl">è¿æ¥ä¸­â€¦</span>
    <button class="btn ghost sm" id="chatToggle" onclick="toggleChat()">ğŸ’¬ AI</button>
    <button class="btn sm" id="addTaskBtn" onclick="openModal()" style="display:none">+ ä»»åŠ¡</button>
  </div>
</header>

<div class="tabs">
  <div class="tab active" data-tab="tasks" onclick="switchTab('tasks',this)">ğŸ“‹ ä»»åŠ¡çœ‹æ¿</div>
  <div class="tab" data-tab="config" onclick="switchTab('config',this)">âš™ï¸ é…ç½®</div>
  <div class="tab" data-tab="files" onclick="switchTab('files',this)">ğŸ“ æ–‡ä»¶</div>
  <div class="tab" data-tab="crs" onclick="switchTab('crs',this)">â˜ï¸ CRS</div>
</div>

<div class="main">
  <div class="content">

    <!-- â”€â”€ Tab: Tasks â”€â”€ -->
    <div class="page active" id="page-tasks">
      <div class="toolbar" id="toolbar">
        <span style="font-size:11px;color:var(--text2)">ç­›é€‰ï¼š</span>
        <button class="filter-btn active" data-filter="all" onclick="setFilter('all',this)">å…¨éƒ¨</button>
      </div>
      <div class="stats" id="statsBar"></div>
      <div class="board">
        <div class="col">
          <div class="col-hdr"><div class="col-title"><div class="col-dot" style="background:#8b949e"></div>å¾…åŠ</div><span class="badge" id="cnt-todo">0</span></div>
          <div class="cards" id="col-todo"></div>
        </div>
        <div class="col">
          <div class="col-hdr"><div class="col-title"><div class="col-dot" style="background:var(--accent)"></div>è¿›è¡Œä¸­</div><span class="badge" id="cnt-in-progress">0</span></div>
          <div class="cards" id="col-in-progress"></div>
        </div>
        <div class="col">
          <div class="col-hdr"><div class="col-title"><div class="col-dot" style="background:var(--green)"></div>å®Œæˆ</div><span class="badge" id="cnt-done">0</span></div>
          <div class="cards" id="col-done"></div>
        </div>
      </div>
    </div>

    <!-- â”€â”€ Tab: Config â”€â”€ -->
    <div class="page" id="page-config">
      <div class="config-grid" id="configGrid">
        <div class="card-block">
          <h3>ğŸ”Œ æœåŠ¡çŠ¶æ€</h3>
          <div class="kv" id="svcStatus">
            <div class="kv-row"><span class="kv-key">TaskBoard (18790)</span><span class="kv-val ok">â— è¿è¡Œä¸­</span></div>
            <div class="kv-row"><span class="kv-key">Gateway (18789)</span><span class="kv-val" id="gwStatus">æ£€æµ‹ä¸­â€¦</span></div>
          </div>
        </div>
        <div class="card-block">
          <h3>ğŸ¤– æ¨¡å‹é…ç½®</h3>
          <div class="kv">
            <div class="kv-row"><span class="kv-key">ä¸»åŠ›æ¨¡å‹</span><span class="kv-val ok">claude-sonnet-4-6</span></div>
            <div class="kv-row"><span class="kv-key">Fallback 1</span><span class="kv-val">claude-opus-4-6</span></div>
            <div class="kv-row"><span class="kv-key">Fallback 2</span><span class="kv-val">gemini-3-pro-preview</span></div>
            <div class="kv-row"><span class="kv-key">å­ Agent</span><span class="kv-val">gemini-3-flash-preview</span></div>
          </div>
        </div>
        <div class="card-block">
          <h3>ğŸ“¡ æ¸ é“</h3>
          <div class="kv">
            <div class="kv-row"><span class="kv-key">Telegram</span><span class="kv-val ok">â— å¯ç”¨</span></div>
            <div class="kv-row"><span class="kv-key">DingTalk</span><span class="kv-val ok">â— å¯ç”¨</span></div>
            <div class="kv-row"><span class="kv-key">WeCom</span><span class="kv-val ok">â— å¯ç”¨</span></div>
            <div class="kv-row"><span class="kv-key">Discord</span><span class="kv-val warn">â— éƒ¨åˆ†</span></div>
          </div>
        </div>
        <div class="card-block">
          <h3>ğŸ”‘ å‡­æ®</h3>
          <div class="kv">
            <div class="kv-row"><span class="kv-key">GitHub PAT</span><span class="kv-val ok">ghp_3k8Gâ€¦fhKff</span></div>
            <div class="kv-row"><span class="kv-key">Anthropic Proxy</span><span class="kv-val ok">cr_8266â€¦b10</span></div>
            <div class="kv-row"><span class="kv-key">Google Gemini</span><span class="kv-val ok">AIzaSyâ€¦RZk</span></div>
            <div class="kv-row"><span class="kv-key">Brave Search</span><span class="kv-val ok">BSAzA6â€¦YB</span></div>
            <div class="kv-row"><span class="kv-key">Gateway Token</span><span class="kv-val ok">123456</span></div>
          </div>
        </div>
        <div class="card-block" style="grid-column:1/-1">
          <h3>ğŸ’¬ Sessions</h3>
          <div id="sessionList"><div style="color:var(--text2);font-size:12px">åŠ è½½ä¸­â€¦</div></div>
        </div>
      </div>
    </div>

    <!-- â”€â”€ Tab: CRS â”€â”€ -->
    <div class="page" id="page-crs">

      <!-- æ¨¡å—1: CRS -->
      <div class="section-hdr">ğŸ”— CRS Â· Claude Relay Service</div>
      <div class="stats" id="crsStats" style="margin-bottom:14px"></div>
      <div class="config-grid" style="margin-bottom:20px">
        <div class="card-block">
          <h3>ğŸ”‘ API Keys</h3>
          <div id="crsKeys"><div style="color:var(--text2);font-size:12px">åŠ è½½ä¸­â€¦</div></div>
        </div>
        <div class="card-block">
          <h3>ğŸ‘¤ è´¦æˆ·çŠ¶æ€</h3>
          <div id="crsAccounts"><div style="color:var(--text2);font-size:12px">åŠ è½½ä¸­â€¦</div></div>
        </div>
        <div class="card-block" style="grid-column:1/-1">
          <h3>ğŸ“Š ä»Šæ—¥ Token ç”¨é‡</h3>
          <div id="crsUsage"><div style="color:var(--text2);font-size:12px">åŠ è½½ä¸­â€¦</div></div>
        </div>
      </div>

      <!-- æ¨¡å—2: Google Cloud -->
      <div class="section-hdr">â˜ï¸ Google Cloud Â· Gemini API</div>
      <div class="config-grid" style="margin-bottom:20px">
        <div class="card-block" style="grid-column:1/-1">
          <div id="gcpStats"><div style="color:var(--text2);font-size:12px">åŠ è½½ä¸­â€¦</div></div>
        </div>
      </div>

      <!-- æ¨¡å—3: OpenAI -->
      <div class="section-hdr">ğŸ¤– OpenAI Â· API ç”¨é‡</div>
      <div class="config-grid">
        <div class="card-block" style="grid-column:1/-1">
          <div id="openaiStats"><div style="color:var(--text2);font-size:12px">åŠ è½½ä¸­â€¦</div></div>
        </div>
      </div>

    </div>

    <!-- â”€â”€ Tab: Files â”€â”€ -->
    <div class="page" id="page-files">
      <div class="files-layout">
        <div class="file-list" id="fileList">
          <div class="file-list-hdr">æ–‡ä»¶</div>
          <div id="fileListContent"><div style="padding:12px;font-size:12px;color:var(--text2)">åŠ è½½ä¸­â€¦</div></div>
        </div>
        <div class="editor-area" id="editorArea">
          <div class="file-placeholder">â† é€‰æ‹©æ–‡ä»¶æŸ¥çœ‹</div>
        </div>
      </div>
    </div>

  </div>

  <!-- â”€â”€ Chat panel â”€â”€ -->
  <div class="chat-panel" id="chatPanel">
    <div class="chat-hdr">
      <div class="chat-hdr-title"><div class="ai-dot"></div>Claude AI <span style="font-size:10px;color:var(--text2);font-weight:400">via Gateway</span></div>
      <div style="display:flex;gap:5px">
        <button class="btn ghost sm" onclick="clearChat()">æ¸…ç©º</button>
      </div>
    </div>
    <div class="chat-session-info">
      <span>Session:</span>
      <span class="sk" id="chatSessionKey">agent:main:main</span>
    </div>
    <div class="chat-msgs" id="chatMsgs">
      <div class="msg assistant"><div class="role">Claude</div><div class="body">ä½ å¥½ï¼å¯ä»¥ç›´æ¥è·Ÿæˆ‘è¯´è¯æ“ä½œçœ‹æ¿ï¼Œæˆ–é—®ä»»ä½•é—®é¢˜ã€‚æ¶ˆæ¯ä¸ Telegram åˆæµã€‚</div></div>
    </div>
    <div class="chat-input-area">
      <textarea class="chat-input" id="chatInput" placeholder="è¾“å…¥æ¶ˆæ¯â€¦ (Ctrl+Enter)" rows="1" oninput="autoResize(this)" onkeydown="chatKey(event)"></textarea>
      <button class="send-btn" id="sendBtn" onclick="sendMsg()">â†‘</button>
    </div>
  </div>

  <!-- â”€â”€ Task Detail Panel (V2) â”€â”€ -->
  <div class="detail-overlay" id="detailOverlay" onclick="closeDetail()"></div>
  <div class="detail-panel" id="detailPanel">
    <div class="detail-hdr">
      <h2 id="dTitleH">ä»»åŠ¡è¯¦æƒ…</h2>
      <div style="display:flex;gap:8px">
        <button class="btn sm" onclick="saveDetail()">ä¿å­˜</button>
        <button class="btn ghost sm" onclick="closeDetail()">âœ•</button>
      </div>
    </div>
    <div class="detail-body">
      <div class="detail-section">
        <h3>åŸºæœ¬ä¿¡æ¯</h3>
        <div class="fg"><label>æ ‡é¢˜</label><input id="dTitle" placeholder="ä»»åŠ¡æ ‡é¢˜"></div>
        <div class="fg"><label>æè¿°</label><textarea id="dDesc" placeholder="ä»»åŠ¡æè¿°" rows="3"></textarea></div>
        <div class="form-row">
          <div class="fg"><label>é¡¹ç›®</label><select id="dProject"></select></div>
          <div class="fg"><label>ä¼˜å…ˆçº§</label>
            <select id="dPri"><option value="high">ğŸ”´ é«˜</option><option value="medium">ğŸŸ¡ ä¸­</option><option value="low">ğŸŸ¢ ä½</option></select>
          </div>
        </div>
      </div>

      <div class="detail-section">
        <h3>OpenClaw Session</h3>
        <div class="fg"><label>Session Key</label>
          <div style="display:flex;gap:5px">
            <input id="dSessionKey" placeholder="task:123..." style="font-family:monospace">
            <button class="btn ghost sm" onclick="generateSessionKey()">è‡ªåŠ¨</button>
          </div>
        </div>
        <div id="dTokenInfo" style="margin-top:8px">
          <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text2);margin-bottom:3px">
            <span id="dTokenLbl">Token ç”¨é‡: -</span>
            <span id="dTokenPct">-</span>
          </div>
          <div class="prog-bar"><div id="dTokenBar" class="prog-fill" style="width:0%"></div></div>
        </div>
      </div>

      <div class="detail-section">
        <h3>å¯¹è¯å†å² <span id="dChatStatus" style="font-weight:400;text-transform:none;letter-spacing:0;color:var(--text2);font-size:10px"></span></h3>
        <div class="dchat-area" id="dChatArea">
          <div class="dchat-msgs" id="dChatMsgs"></div>
          <div class="dchat-input-row">
            <div id="dChatFileChips" class="dchat-file-chips"></div>
            <div class="dchat-input-area">
              <button class="upload-btn" onclick="dchatPickFile()" title="ä¸Šä¼ æ–‡ä»¶åˆ° files[]">ğŸ“</button>
              <textarea class="dchat-input" id="dChatInput" placeholder="å‘æ¶ˆæ¯åˆ°æ­¤ sessionâ€¦ (Enter å‘é€, Shift+Enter æ¢è¡Œ)" onkeydown="dChatKey(event)" oninput="autoResizeDChat(this)"></textarea>
              <button class="send-btn" id="dSendBtn" onclick="sendDChat()" style="width:32px;height:32px;flex-shrink:0">â†‘</button>
            </div>
          </div>
        </div>
      </div>

      <div class="detail-section">
        <h3>å…³è”æ–‡ä»¶ <span id="dFilesCount" style="color:var(--text2);font-weight:400;font-size:10px;text-transform:none;letter-spacing:0"></span></h3>
        <div class="dfiles-list" id="dFilesList"></div>
        <div style="display:flex;gap:5px;margin-top:8px">
          <button class="btn ghost sm" onclick="addDFile()" style="flex:1">+ æ‰‹åŠ¨è¾“å…¥è·¯å¾„</button>
          <label class="btn ghost sm" style="flex:1;text-align:center;cursor:pointer">
            ğŸ“ é€‰æ‹©æ–‡ä»¶
            <input type="file" id="dFileUploadInput" style="display:none" multiple onchange="handleDFileUpload(event)">
          </label>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Task Modal -->
<div class="modal-bg" id="modalBg" onclick="closeMBg(event)">
  <div class="modal">
    <h2 id="modalTitle">æ–°å»ºä»»åŠ¡</h2>
    <div class="fg"><label>æ ‡é¢˜ *</label><input id="fTitle" placeholder="ä»»åŠ¡æ ‡é¢˜"></div>
    <div class="fg"><label>æè¿°</label><textarea id="fDesc" placeholder="å¯é€‰"></textarea></div>
    <div class="form-row">
      <div class="fg"><label>é¡¹ç›®</label><select id="fProject"></select></div>
      <div class="fg"><label>ä¼˜å…ˆçº§</label>
        <select id="fPri"><option value="high">ğŸ”´ é«˜</option><option value="medium" selected>ğŸŸ¡ ä¸­</option><option value="low">ğŸŸ¢ ä½</option></select>
      </div>
    </div>
    <div class="form-row">
      <div class="fg"><label>çŠ¶æ€</label>
        <select id="fStatus"><option value="todo">å¾…åŠ</option><option value="in-progress">è¿›è¡Œä¸­</option><option value="done">å®Œæˆ</option></select>
      </div>
      <div class="fg"><label>æˆªæ­¢æ—¥æœŸ</label><input type="date" id="fDue"></div>
    </div>
    <div class="fg"><label>æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰</label><input id="fTags" placeholder="iec, smarts"></div>
    <div class="fg context-note-fg">
      <label>ğŸ§  åˆå§‹ Context Note (ç»™ AI çš„åˆå§‹æŒ‡ä»¤/ä¸Šä¸‹æ–‡)</label>
      <textarea id="fContextNote" placeholder="ä¾‹å¦‚ï¼šä½ æ˜¯ä¸€ä¸ªèµ„æ·±è¿ç»´ä¸“å®¶ï¼Œè´Ÿè´£æ­¤ä»»åŠ¡çš„ç³»ç»Ÿæ¶æ„è®¾è®¡ã€‚è¯·ä¼˜å…ˆè€ƒè™‘å¯ç»´æŠ¤æ€§å’Œæ€§èƒ½ã€‚&#10;&#10;ç•™ç©ºåˆ™ä¸è‡ªåŠ¨å‘é€åˆå§‹æ¶ˆæ¯ã€‚" rows="4"></textarea>
      <div style="font-size:10px;color:var(--purple);margin-top:3px;opacity:.8">ğŸ’¡ ä¿å­˜åè‡ªåŠ¨åˆ›å»º Session å¹¶å‘é€æ­¤æ¶ˆæ¯ä½œä¸ºé¦–æ¡æŒ‡ä»¤</div>
    </div>
    <div class="modal-actions">
      <button class="btn sec" onclick="closeModal()">å–æ¶ˆ</button>
      <button class="btn" onclick="saveTask()">ä¿å­˜</button>
    </div>
  </div>
</div>

<script>
const TAPI = `http://${location.hostname}:18790/api`;
const GW   = `http://${location.hostname}:18790/gateway`;
const SK   = 'agent:main:main';

let tasks=[], projects=[], filter='all', editId=null, streaming=false;
let ws, currentFile=null, fileMode='view', sessionCache=[];

// â”€â”€ Token â”€â”€
function getToken(){ return localStorage.getItem('ocToken') || '123456'; }
document.addEventListener('DOMContentLoaded', ()=>{
  if (!localStorage.getItem('ocToken')) localStorage.setItem('ocToken', '123456');
  
  // Periodically refresh session cache for token bars
  setInterval(refreshSessionCache, 30000);
  refreshSessionCache();
});

async function refreshSessionCache() {
  try {
    const r = await fetch(`http://${location.hostname}:18790/api/openclaw/sessions`, { headers: { Authorization: `Bearer ${getToken()}` } });
    if (r.ok) {
      const d = await r.json();
      sessionCache = d.sessions || d || [];
      renderBoard();
    }
  } catch (e) {}
}

// â”€â”€ WebSocket â”€â”€
function connectWS(){
  ws = new WebSocket(`ws://${location.hostname}:18790`);
  ws.onopen = ()=>setWS(true);
  ws.onclose = ()=>{ setWS(false); setTimeout(connectWS,3000); };
  ws.onmessage = e=>{
    const m = JSON.parse(e.data);
    if(m.type==='tasks'){ tasks=m.data.tasks; projects=m.data.projects; renderBoard(); }
  };
}
function setWS(on){
  document.getElementById('wsDot').className='ws-dot'+(on?' on':'');
  document.getElementById('wsLbl').textContent=on?'å®æ—¶åŒæ­¥':'å·²æ–­å¼€';
}

// â”€â”€ Tabs â”€â”€
function switchTab(id, el){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('page-'+id).classList.add('active');
  document.getElementById('addTaskBtn').style.display = id==='tasks'?'':'none';
  if(id==='config') loadConfig();
  if(id==='files') loadFiles();
  if(id==='crs') { loadCRS(); loadGCP(); loadOpenAI(); }
}

// â”€â”€ Utilities â”€â”€
function escHtml(s){ if(!s)return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// â”€â”€ Board â”€â”€
function renderBoard(){
  const tb = document.getElementById('toolbar');
  const ex = new Set([...tb.querySelectorAll('[data-filter]')].map(b=>b.dataset.filter));
  projects.forEach(p=>{
    if(!ex.has(p)){
      const b=document.createElement('button'); b.className='filter-btn'; b.dataset.filter=p; b.textContent=p;
      b.onclick=()=>setFilter(p,b); tb.appendChild(b);
    }
  });
  const f = filter==='all'?tasks:tasks.filter(t=>t.project===filter);
  const todo=f.filter(t=>t.status==='todo').length, inp=f.filter(t=>t.status==='in-progress').length, done=f.filter(t=>t.status==='done').length;
  document.getElementById('statsBar').innerHTML=`
    <div class="stat"><div class="num">${f.length}</div><div class="lbl">æ€»ä»»åŠ¡</div></div>
    <div class="stat"><div class="num" style="color:var(--text2)">${todo}</div><div class="lbl">å¾…åŠ</div></div>
    <div class="stat"><div class="num" style="color:var(--accent)">${inp}</div><div class="lbl">è¿›è¡Œä¸­</div></div>
    <div class="stat"><div class="num" style="color:var(--green)">${done}</div><div class="lbl">å·²å®Œæˆ</div></div>
    <div class="stat"><div class="num" style="color:var(--yellow)">${f.length?Math.round(done/f.length*100):0}%</div><div class="lbl">å®Œæˆç‡</div></div>`;
  ['todo','in-progress','done'].forEach(s=>{
    const col=document.getElementById('col-'+s), cnt=document.getElementById('cnt-'+s);
    const items=f.filter(t=>t.status===s);
    cnt.textContent=items.length;
    col.innerHTML=items.length?items.map(cardHTML).join(''):'<div class="empty">æš‚æ— ä»»åŠ¡</div>';
  });
  const sel=document.getElementById('fProject'), cur=sel.value;
  sel.innerHTML=projects.map(p=>`<option value="${p}"${p===cur?' selected':''}>${p}</option>`).join('')+'<option value="__new__">+ æ–°é¡¹ç›®â€¦</option>';
}

function cardHTML(t){
  const due=t.dueDate?new Date(t.dueDate):null, ov=due&&due<new Date()&&t.status!=='done';
  const dueS=due?due.toLocaleDateString('zh-CN'):'';
  
  // Token usage from cache
  let tokenBar = '';
  let tokenPct = 0;
  if (t.sessionKey) {
    const s = sessionCache.find(x => x.key === t.sessionKey || x.sessionKey === t.sessionKey);
    if (s) {
      const used = s.totalTokens || 0, ctx = s.contextTokens || 200000;
      tokenPct = Math.min(Math.round(used / ctx * 100), 100);
      const cls = tokenPct > 90 ? 'err' : tokenPct > 70 ? 'warn' : '';
      const usedK = (used/1000).toFixed(1), ctxK = (ctx/1000).toFixed(0);
      tokenBar = `<div style="display:flex;justify-content:space-between;font-size:9px;color:var(--text2);margin-top:6px;margin-bottom:2px">
        <span>tokens</span><span>${usedK}k / ${ctxK}k (${tokenPct}%)</span>
      </div>
      <div class="prog-bar" style="height:2px"><div class="prog-fill ${cls}" style="width:${tokenPct}%"></div></div>`;
    } else {
      tokenBar = `<div style="margin-top:6px;font-size:9px;color:var(--text2);opacity:.6">â¬¡ session: ${t.sessionKey.slice(0,28)}${t.sessionKey.length>28?'â€¦':''}</div>`;
    }
  }

  const fileCount = t.files ? t.files.length : 0;
  const alertClass = tokenPct >= 90 ? 'border-color:var(--red)' : tokenPct >= 75 ? 'border-color:var(--yellow)' : '';

  return `<div class="card" onclick="openDetail('${t.id}')" style="${alertClass}">
    <div class="card-actions">
      <button class="icon-btn" onclick="cycleStatus(event,'${t.id}','${t.status}')" title="åˆ‡æ¢çŠ¶æ€">âŸ³</button>
      <button class="icon-btn del" onclick="delTask(event,'${t.id}')" title="åˆ é™¤">âœ•</button>
    </div>
    <div class="card-title">${escHtml(t.title)}</div>
    ${t.description?`<div class="card-desc">${escHtml(t.description)}</div>`:''}
    <div class="card-meta">
      <span class="tag p-${t.priority}">${{high:'ğŸ”´ é«˜',medium:'ğŸŸ¡ ä¸­',low:'ğŸŸ¢ ä½'}[t.priority]}</span>
      <span class="tag t-project">${escHtml(t.project)}</span>
      ${dueS?`<span class="tag t-due ${ov?'ov':''}">${ov?'âš ï¸ ':'ğŸ“… '}${dueS}</span>`:''}
      ${fileCount ? `<span class="tag" style="border-color:var(--border);color:var(--text2)" title="${(t.files||[]).join('\n')}">ğŸ“ ${fileCount}</span>` : ''}
      ${t.sessionKey ? `<span class="tag" style="color:var(--accent);border-color:rgba(88,166,255,.3);background:rgba(88,166,255,.05)" title="${t.sessionKey}">ğŸ”— session</span>` : ''}
    </div>
    ${tokenBar}
  </div>`;
}

function cycleStatus(e,id,cur){ e.stopPropagation(); const n={todo:'in-progress','in-progress':'done',done:'todo'}; fetch(`${TAPI}/tasks/${id}`,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({status:n[cur]})}); }
function delTask(e,id){ e.stopPropagation(); if(!confirm('ç¡®è®¤åˆ é™¤ï¼Ÿ'))return; fetch(`${TAPI}/tasks/${id}`,{method:'DELETE'}); }
function setFilter(f,btn){ filter=f; document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); renderBoard(); }

// â”€â”€ Config â”€â”€
async function loadConfig(){
  // gateway health
  try{
    const r=await fetch(`${GW}/api/health`,{headers:{Authorization:`Bearer ${getToken()}`}});
    document.getElementById('gwStatus').textContent=r.ok?'â— è¿è¡Œä¸­':'â— å¼‚å¸¸';
    document.getElementById('gwStatus').className='kv-val '+(r.ok?'ok':'err');
  }catch{ document.getElementById('gwStatus').textContent='â— æ— æ³•è¿æ¥'; document.getElementById('gwStatus').className='kv-val err'; }

  // sessions
  try{
    const r=await fetch(`http://${location.hostname}:18790/api/openclaw/sessions`,{headers:{Authorization:`Bearer ${getToken()}`}});
    if(r.ok){
      const d=await r.json();
      const sessions=d.sessions||d||[];
      document.getElementById('sessionList').innerHTML=sessions.map(s=>{
        const used=s.totalTokens||0, ctx=s.contextTokens||200000;
        const pct=Math.min(Math.round(used/ctx*100),100);
        const cls=pct>90?'err':pct>70?'warn':'';
        return `<div class="session-row">
          <div class="session-key">${s.key||s.sessionKey||'unknown'}</div>
          <div class="session-meta">
            <span>${s.channel||'-'}</span>
            <span>${s.model||'-'}</span>
            <span>${(used/1000).toFixed(1)}k / ${(ctx/1000).toFixed(0)}k tokens</span>
          </div>
          <div class="prog-bar"><div class="prog-fill ${cls}" style="width:${pct}%"></div></div>
        </div>`;
      }).join('') || '<div style="font-size:12px;color:var(--text2)">æ— æ•°æ®</div>';
    }
  }catch(e){ document.getElementById('sessionList').innerHTML=`<div style="font-size:12px;color:var(--text2)">åŠ è½½å¤±è´¥: ${e.message}</div>`; }
}

// â”€â”€ CRS â”€â”€
const CRS = `http://${location.hostname}:18790/crs`;
const CRS_TOKEN = 'b2a7efadba34891a7f25a0c1bd48bcc3006a9d3e2937bed9cce2ef2665583453';

async function loadCRS() {
  const hdr = { Authorization: `Bearer ${CRS_TOKEN}` };

  // API Keys
  try {
    const r = await fetch(`${CRS}/admin/api-keys?page=1&pageSize=20&timeRange=today`, { headers: hdr });
    const d = await r.json();
    const keys = d.data?.items || [];
    let totalCost = 0, totalReqs = 0, totalTokens = 0;
    document.getElementById('crsKeys').innerHTML = keys.map(k => {
      const cost = k.usage?.today?.cost || 0;
      const reqs = k.usage?.today?.requests || 0;
      const tokens = k.usage?.today?.tokens || 0;
      totalCost += cost; totalReqs += reqs; totalTokens += tokens;
      const pct = k.tokenLimit > 0 ? Math.min(Math.round(tokens / k.tokenLimit * 100), 100) : 0;
      return `<div class="session-row">
        <div class="session-key">${k.name}</div>
        <div class="session-meta">
          <span style="color:${k.isActive?'var(--green)':'var(--red)'}">${k.isActive?'â— æ´»è·ƒ':'â— åœç”¨'}</span>
          <span>ä»Šæ—¥è¯·æ±‚: ${reqs}</span>
          <span>Token: ${tokens > 1e6 ? (tokens/1e6).toFixed(2)+'M' : tokens > 1e3 ? (tokens/1e3).toFixed(1)+'K' : tokens}</span>
          <span style="color:var(--yellow)">$${cost.toFixed(4)}</span>
        </div>
        ${k.tokenLimit > 0 ? `<div class="prog-bar"><div class="prog-fill ${pct>90?'err':pct>70?'warn':''}" style="width:${pct}%"></div></div>` : ''}
      </div>`;
    }).join('');

    // Stats bar
    document.getElementById('crsStats').innerHTML = `
      <div class="stat"><div class="num" style="color:var(--yellow)">$${totalCost.toFixed(4)}</div><div class="lbl">ä»Šæ—¥è´¹ç”¨</div></div>
      <div class="stat"><div class="num">${totalReqs}</div><div class="lbl">ä»Šæ—¥è¯·æ±‚</div></div>
      <div class="stat"><div class="num">${totalTokens > 1e6 ? (totalTokens/1e6).toFixed(2)+'M' : (totalTokens/1e3).toFixed(1)+'K'}</div><div class="lbl">ä»Šæ—¥ Token</div></div>
      <div class="stat"><div class="num">${keys.filter(k=>k.isActive).length}/${keys.length}</div><div class="lbl">æ´»è·ƒ Keys</div></div>`;
  } catch(e) { document.getElementById('crsKeys').innerHTML = `<div style="color:var(--red);font-size:12px">åŠ è½½å¤±è´¥: ${e.message}</div>`; }

  // Accounts
  try {
    const r = await fetch(`${CRS}/admin/claude-accounts`, { headers: hdr });
    const d = await r.json();
    const accts = d.data || [];
    document.getElementById('crsAccounts').innerHTML = accts.map(a => {
      const statusColor = a.status === 'active' ? 'var(--green)' : a.status === 'error' ? 'var(--red)' : 'var(--yellow)';
      return `<div class="session-row">
        <div class="session-key">${a.name} <span style="font-size:10px;color:var(--text2)">(${a.email})</span></div>
        <div class="session-meta">
          <span style="color:${statusColor}">â— ${a.status}</span>
          <span>${a.authType}</span>
          <span>æœ€åç”¨: ${a.lastUsedAt ? new Date(a.lastUsedAt).toLocaleTimeString('zh-CN') : '-'}</span>
        </div>
      </div>`;
    }).join('') || '<div style="font-size:12px;color:var(--text2)">æ— è´¦æˆ·</div>';
  } catch(e) { document.getElementById('crsAccounts').innerHTML = `<div style="color:var(--red);font-size:12px">åŠ è½½å¤±è´¥</div>`; }

  // Batch stats via POST
  try {
    const keysR = await fetch(`${CRS}/admin/api-keys?page=1&pageSize=20&searchMode=apiKey&sortBy=createdAt&sortOrder=desc&timeRange=today`, { headers: hdr });
    const keysD = await keysR.json();
    const keyItems = keysD.data?.items || [];
    const keyIds = keyItems.map(k => k.id);

    if (keyIds.length) {
      const statsR = await fetch(`${CRS}/admin/api-keys/batch-stats`, {
        method: 'POST',
        headers: { ...hdr, 'Content-Type': 'application/json' },
        body: JSON.stringify({ keyIds, timeRange: 'today' })
      });
      const statsD = await statsR.json();
      const statsMap = statsD.data || {};

      // æ›´æ–° API Keys æ˜¾ç¤ºï¼ˆç”¨çœŸå®æ•°æ®ï¼‰
      let totalCost=0, totalReqs=0, totalTokens=0;
      document.getElementById('crsKeys').innerHTML = keyItems.map(k => {
        const s = statsMap[k.id] || {};
        const cost = s.cost || 0, reqs = s.requests || 0, tokens = s.tokens || 0;
        totalCost += cost; totalReqs += reqs; totalTokens += tokens;
        const fmtTokens = tokens > 1e6 ? (tokens/1e6).toFixed(2)+'M' : tokens > 1e3 ? (tokens/1e3).toFixed(1)+'K' : tokens;
        return `<div class="session-row">
          <div class="session-key">${k.name}</div>
          <div class="session-meta">
            <span style="color:${k.isActive?'var(--green)':'var(--red)'}">${k.isActive?'â— æ´»è·ƒ':'â— åœç”¨'}</span>
            <span>ä»Šæ—¥è¯·æ±‚: <strong style="color:var(--text)">${reqs}</strong></span>
            <span>Token: <strong style="color:var(--text)">${fmtTokens}</strong></span>
            <span style="color:var(--yellow);font-weight:600">$${cost.toFixed(4)}</span>
          </div>
          <div style="font-size:11px;color:var(--text2);margin-top:4px">
            è¾“å…¥: ${(s.inputTokens||0).toLocaleString()} Â· è¾“å‡º: ${(s.outputTokens||0).toLocaleString()} Â· ç¼“å­˜åˆ›å»º: ${((s.cacheCreateTokens||0)/1e3).toFixed(1)}K Â· ç¼“å­˜è¯»å–: ${((s.cacheReadTokens||0)/1e6).toFixed(2)}M
          </div>
        </div>`;
      }).join('');

      // æ›´æ–° stats bar
      document.getElementById('crsStats').innerHTML = `
        <div class="stat"><div class="num" style="color:var(--yellow)">$${totalCost.toFixed(2)}</div><div class="lbl">ä»Šæ—¥è´¹ç”¨</div></div>
        <div class="stat"><div class="num">${totalReqs}</div><div class="lbl">ä»Šæ—¥è¯·æ±‚</div></div>
        <div class="stat"><div class="num">${totalTokens>1e6?(totalTokens/1e6).toFixed(1)+'M':(totalTokens/1e3).toFixed(1)+'K'}</div><div class="lbl">ä»Šæ—¥ Token</div></div>
        <div class="stat"><div class="num">${keyItems.filter(k=>k.isActive).length}/${keyItems.length}</div><div class="lbl">æ´»è·ƒ Keys</div></div>`;

      // Token æ˜ç»†è¡¨
      const totalIn = keyIds.reduce((a,id)=>a+(statsMap[id]?.inputTokens||0),0);
      const totalOut = keyIds.reduce((a,id)=>a+(statsMap[id]?.outputTokens||0),0);
      const totalCC = keyIds.reduce((a,id)=>a+(statsMap[id]?.cacheCreateTokens||0),0);
      const totalCR = keyIds.reduce((a,id)=>a+(statsMap[id]?.cacheReadTokens||0),0);
      document.getElementById('crsUsage').innerHTML = `
        <div class="kv">
          <div class="kv-row"><span class="kv-key">è¾“å…¥ Token</span><span class="kv-val">${totalIn.toLocaleString()}</span></div>
          <div class="kv-row"><span class="kv-key">è¾“å‡º Token</span><span class="kv-val">${totalOut.toLocaleString()}</span></div>
          <div class="kv-row"><span class="kv-key">ç¼“å­˜åˆ›å»º</span><span class="kv-val">${(totalCC/1e6).toFixed(2)}M</span></div>
          <div class="kv-row"><span class="kv-key">ç¼“å­˜è¯»å–</span><span class="kv-val" style="color:var(--green)">${(totalCR/1e6).toFixed(2)}M</span></div>
          <div class="kv-row"><span class="kv-key">æ€» Token</span><span class="kv-val ok">${(totalTokens/1e6).toFixed(2)}M</span></div>
          <div class="kv-row"><span class="kv-key">æ€»è´¹ç”¨</span><span class="kv-val warn">$${totalCost.toFixed(4)}</span></div>
        </div>
        <div style="margin-top:10px;font-size:11px;color:var(--text2)">ğŸ’¡ ä½¿ç”¨æ¨¡å‹ï¼šclaude-sonnet-4-6, claude-haiku-4-5, claude-opus-4-6</div>`;
    }
  } catch(e) { document.getElementById('crsUsage').innerHTML = `<div style="color:var(--red);font-size:12px">åŠ è½½å¤±è´¥: ${e.message}</div>`; }
}

// â”€â”€ GCP â”€â”€
async function loadGCP() {
  try {
    const r = await fetch(`${TAPI}/gcp/gemini`);
    const d = await r.json();
    if (!d.ok) throw new Error(d.error);
    const b = d.billing;
    document.getElementById('gcpStats').innerHTML = `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
        <div class="stat"><div class="num" style="color:var(--yellow)">$${b.grossCost.toFixed(2)}</div><div class="lbl">æœ¬æœˆåŸå§‹è´¹ç”¨</div></div>
        <div class="stat"><div class="num" style="color:var(--green)">$${b.netCost.toFixed(2)}</div><div class="lbl">æœ¬æœˆå®ä»˜ï¼ˆcredits æŠµæ‰£ï¼‰</div></div>
        <div class="stat"><div class="num">${d.todayRequests.toLocaleString()}</div><div class="lbl">ä»Šæ—¥è¯·æ±‚æ•°</div></div>
        <div class="stat"><div class="num">${d.monthRequests.toLocaleString()}</div><div class="lbl">æœ¬æœˆè¯·æ±‚æ•°</div></div>
      </div>
      <div class="kv">
        <div class="kv-row"><span class="kv-key">Credits æŠµæ‰£</span><span class="kv-val ok">-$${b.credits.toFixed(2)}</span></div>
        <div class="kv-row"><span class="kv-key">è´¦æœŸ</span><span class="kv-val">${b.period}</span></div>
        <div class="kv-row"><span class="kv-key">Billing Account</span><span class="kv-val" style="font-family:monospace;font-size:11px">${b.accountId}</span></div>
        <div class="kv-row">
          <span class="kv-key">å¿«æ·é“¾æ¥</span>
          <span class="kv-val">
            <a href="${d.billingUrl}" target="_blank" style="color:var(--accent);margin-right:10px">ğŸ“Š Billing Console</a>
            <a href="${d.monitoringUrl}" target="_blank" style="color:var(--accent)">ğŸ“ˆ Monitoring</a>
          </span>
        </div>
      </div>
      <div style="font-size:11px;color:var(--text2);margin-top:8px">âš ï¸ ${b.note}</div>`;
  } catch(e) {
    document.getElementById('gcpStats').innerHTML = `<div style="color:var(--red);font-size:12px">åŠ è½½å¤±è´¥: ${e.message}</div>`;
  }
}

// â”€â”€ OpenAI â”€â”€
async function loadOpenAI() {
  try {
    const r = await fetch(`${TAPI}/openai/costs`);
    const d = await r.json();
    if (!d.ok) throw new Error(d.error);

    const modelRows = d.models.map(m => {
      const pct = Math.round(m.cost / d.total * 100);
      const barW = Math.max(2, pct);
      return `<div style="margin-bottom:8px">
        <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:3px">
          <span style="color:var(--text1);font-family:monospace;font-size:11px">${m.name}</span>
          <span style="color:var(--text2)">$${m.cost.toFixed(4)} <span style="color:var(--text3)">(${pct}%)</span></span>
        </div>
        <div class="prog-bar"><div class="prog-fill ${pct>50?'warn':''}" style="width:${barW}%"></div></div>
      </div>`;
    }).join('');

    const dailyRows = d.daily.slice(-7).map(day => {
      const maxCost = Math.max(...d.daily.map(x=>x.cost), 0.01);
      const barW = Math.round(day.cost / maxCost * 100);
      return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:5px;font-size:12px">
        <span style="color:var(--text2);width:80px;flex-shrink:0">${day.date}</span>
        <div class="prog-bar" style="flex:1"><div class="prog-fill" style="width:${barW}%"></div></div>
        <span style="color:var(--text1);width:60px;text-align:right">$${day.cost.toFixed(4)}</span>
      </div>`;
    }).join('');

    document.getElementById('openaiStats').innerHTML = `
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px">
        <div class="stat"><div class="num" style="color:var(--yellow)">$${d.total.toFixed(4)}</div><div class="lbl">æœ¬æœˆåˆè®¡</div></div>
        <div class="stat"><div class="num" style="color:var(--text2)">${d.period}</div><div class="lbl">è´¦æœŸ</div></div>
        <div class="stat"><div class="num" style="color:var(--green);font-size:13px">${d.topModel}</div><div class="lbl">ä¸»è¦æ¶ˆè€—æ¨¡å‹</div></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
        <div>
          <div style="font-size:12px;font-weight:600;color:var(--text2);margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px">æŒ‰æ¨¡å‹åˆ†å¸ƒ</div>
          ${modelRows}
        </div>
        <div>
          <div style="font-size:12px;font-weight:600;color:var(--text2);margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px">è¿‘7å¤©è¶‹åŠ¿</div>
          ${dailyRows}
        </div>
      </div>`;
  } catch(e) {
    document.getElementById('openaiStats').innerHTML = `<div style="color:var(--red);font-size:12px">åŠ è½½å¤±è´¥: ${e.message}</div>`;
  }
}

// â”€â”€ Files â”€â”€
async function loadFiles(){
  const r=await fetch(`${TAPI}/files`); const files=await r.json();
  const root=files.filter(f=>!f.path.includes('/')), mem=files.filter(f=>f.path.startsWith('memory/'));
  let html='';
  if(root.length){ html+=root.map(f=>`<div class="file-item" data-path="${f.path}" onclick="openFile('${f.path}',this)"><span class="file-name">${f.name}</span><span class="file-size">${(f.size/1024).toFixed(1)}k</span></div>`).join(''); }
  if(mem.length){ html+=`<div class="file-section">memory/</div>`+mem.map(f=>`<div class="file-item" data-path="${f.path}" onclick="openFile('${f.path}',this)"><span class="file-name">${f.name}</span><span class="file-size">${(f.size/1024).toFixed(1)}k</span></div>`).join(''); }
  document.getElementById('fileListContent').innerHTML=html||'<div style="padding:12px;font-size:12px;color:var(--text2)">æ— æ–‡ä»¶</div>';
}

async function openFile(p, el){
  document.querySelectorAll('.file-item').forEach(i=>i.classList.remove('active')); el.classList.add('active');
  currentFile=p; fileMode='view';
  const r=await fetch(`${TAPI}/file?path=${encodeURIComponent(p)}`);
  const d=await r.json();
  if(d.error){ renderEditor(p, `âŒ åŠ è½½å¤±è´¥: ${d.error}`); return; }
  renderEditor(p, d.content);
}

function renderEditor(p, content){
  const ea=document.getElementById('editorArea');
  ea.innerHTML=`
    <div class="editor-toolbar">
      <span class="editor-filename">${p}</span>
      <div class="editor-actions">
        <div class="edit-toggle">
          <button id="viewBtn" class="${fileMode==='view'?'active':''}" onclick="setMode('view')">é¢„è§ˆ</button>
          <button id="editBtn" class="${fileMode==='edit'?'active':''}" onclick="setMode('edit')">ç¼–è¾‘</button>
        </div>
        <button class="btn sm" id="saveBtn" onclick="saveFile()" style="display:${fileMode==='edit'?'':'none'}">ä¿å­˜</button>
      </div>
    </div>
    <div id="mdView" class="md-view" style="display:${fileMode==='view'?'':'none'}">${renderMD(content)}</div>
    <textarea id="mdRaw" class="md-raw" style="display:${fileMode==='edit'?'':'none'}">${escHtml(content)}</textarea>`;
}

function setMode(m){
  fileMode=m;
  const raw=document.getElementById('mdRaw'), view=document.getElementById('mdView');
  if(m==='edit'){ raw.style.display=''; view.style.display='none'; }
  else {
    if(raw) { document.getElementById('mdView').innerHTML=renderMD(raw.value); }
    raw.style.display='none'; view.style.display='';
  }
  document.getElementById('viewBtn').className=m==='view'?'active':'';
  document.getElementById('editBtn').className=m==='edit'?'active':'';
  document.getElementById('saveBtn').style.display=m==='edit'?'':'none';
}

async function saveFile(){
  const content=document.getElementById('mdRaw').value;
  await fetch(`${TAPI}/file?path=${encodeURIComponent(currentFile)}`,{method:'PUT',headers:{'Content-Type':'text/plain'},body:content});
  setMode('view');
}

function renderMD(md){
  return md
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/^### (.+)$/gm,'<h3>$1</h3>').replace(/^## (.+)$/gm,'<h2>$1</h2>').replace(/^# (.+)$/gm,'<h1>$1</h1>')
    .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>').replace(/\*(.+?)\*/g,'<em>$1</em>')
    .replace(/`([^`]+)`/g,'<code>$1</code>')
    .replace(/^---$/gm,'<hr>')
    .replace(/^\| (.+)$/gm, m => '<table>'+m.split('\n').filter(l=>l.trim()&&!l.match(/^\|[-\s|]+\|$/)).map(l=>'<tr>'+l.split('|').filter((_,i,a)=>i>0&&i<a.length-1).map(c=>`<td>${c.trim()}</td>`).join('')+'</tr>').join('')+'</table>')
    .replace(/^[-*] (.+)$/gm,'<li>$1</li>').replace(/(<li>.*<\/li>\n?)+/g,'<ul>$&</ul>')
    .replace(/^\d+\. (.+)$/gm,'<li>$1</li>')
    .replace(/\[(.+?)\]\((.+?)\)/g,'<a href="$2" target="_blank">$1</a>')
    .replace(/\n\n/g,'</p><p>').replace(/^(?!<[hulo]|<\/[hulo]|<table|<\/table|<hr)(.+)$/gm,'<p>$1</p>');
}

// â”€â”€ Chat â”€â”€
function toggleChat(){
  const p=document.getElementById('chatPanel'); const on=p.classList.toggle('hidden');
  document.getElementById('chatToggle').textContent= on ? 'ğŸ’¬ AI' : 'âœ• AI';
}
function clearChat(){ document.getElementById('chatMsgs').innerHTML='<div class="msg assistant"><div class="role">Claude</div><div class="body">å·²æ¸…ç©ºã€‚æœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ ï¼Ÿ</div></div>'; }
function autoResize(el){ el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,100)+'px'; }
function chatKey(e){ if((e.metaKey||e.ctrlKey)&&e.key==='Enter'){e.preventDefault();sendMsg();} }

function appendMsg(role,text){
  const m=document.getElementById('chatMsgs');
  const d=document.createElement('div'); d.className=`msg ${role}`;
  d.innerHTML=`<div class="role">${role==='user'?'ä½ ':'Claude'}</div><div class="body">${escHtml(text)}</div>`;
  m.appendChild(d); m.scrollTop=m.scrollHeight;
  return d.querySelector('.body');
}
function showTyping(){ const m=document.getElementById('chatMsgs'); const d=document.createElement('div'); d.id='typ'; d.className='msg assistant'; d.innerHTML='<div class="role">Claude</div><div class="typing"><span></span><span></span><span></span></div>'; m.appendChild(d); m.scrollTop=m.scrollHeight; }
function hideTyping(){ const el=document.getElementById('typ'); if(el)el.remove(); }

async function sendMsg(){
  const inp=document.getElementById('chatInput'), text=inp.value.trim();
  if(!text||streaming)return;
  const token=getToken();
  const sessionKey = document.getElementById('chatSessionKey').textContent || SK;
  inp.value=''; inp.style.height='auto';
  appendMsg('user',text); streaming=true;
  document.getElementById('sendBtn').disabled=true;
  showTyping();
  try{
    const resp=await fetch(`${GW}/v1/chat/completions`,{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`,'x-openclaw-session-key':sessionKey},
      body:JSON.stringify({model:'openclaw:main',stream:true,messages:[{role:'user',content:text}]})
    });
    hideTyping();
    if(!resp.ok){ appendMsg('assistant',`âŒ é”™è¯¯ ${resp.status}: ${await resp.text()}`); return; }
    const body=appendMsg('assistant','');
    body.textContent='';
    const reader=resp.body.getReader(), dec=new TextDecoder(); let buf='';
    while(true){
      const{done,value}=await reader.read(); if(done)break;
      buf+=dec.decode(value,{stream:true});
      const lines=buf.split('\n'); buf=lines.pop();
      for(const line of lines){
        if(!line.startsWith('data: '))continue;
        const d=line.slice(6).trim(); if(d==='[DONE]')break;
        try{ const j=JSON.parse(d); const c=j.choices?.[0]?.delta?.content; if(c){body.textContent+=c; document.getElementById('chatMsgs').scrollTop=9999;} }catch{}
      }
    }
  }catch(e){ hideTyping(); appendMsg('assistant',`âŒ è¿æ¥å¤±è´¥: ${e.message}`); }
  finally{ streaming=false; document.getElementById('sendBtn').disabled=false; }
}

// â”€â”€ Task Detail (V2) â”€â”€
let activeTaskId = null;
let dChatStreaming = false;
let pendingDChatFiles = []; // files to attach with next message (paths for files[])

async function openDetail(id) {
  activeTaskId = id;
  const t = tasks.find(x => x.id === id);
  if (!t) return;

  document.getElementById('dTitleH').textContent = t.title;
  document.getElementById('dTitle').value = t.title;
  document.getElementById('dDesc').value = t.description || '';
  document.getElementById('dSessionKey').value = t.sessionKey || '';
  document.getElementById('dPri').value = t.priority;
  
  // Fill project list in detail
  const dProj = document.getElementById('dProject');
  dProj.innerHTML = projects.map(p => `<option value="${p}"${p === t.project ? ' selected' : ''}>${p}</option>`).join('') + '<option value="__new__">+ æ–°é¡¹ç›®â€¦</option>';

  // Reset pending files
  pendingDChatFiles = [];
  renderDChatFileChips();

  // Reset chat and files
  document.getElementById('dChatMsgs').innerHTML = '<div style="color:var(--text2);font-size:12px;text-align:center;padding:20px">â³ åŠ è½½å¯¹è¯å†å²â€¦</div>';
  renderDFiles(t.files || []);

  // UI open
  document.getElementById('detailPanel').classList.add('open');
  document.getElementById('detailOverlay').classList.add('open');

  // Load session info & history
  if (t.sessionKey) {
    document.getElementById('dChatStatus').textContent = `[${t.sessionKey}]`;
    loadDChat(t.sessionKey);
    updateDSessionStats(t.sessionKey);
  } else {
    document.getElementById('dChatStatus').textContent = '';
    document.getElementById('dChatMsgs').innerHTML = '<div style="color:var(--text2);font-size:12px;text-align:center;padding:20px">ğŸ’¡ æœªç»‘å®š Session<br><small>å¡«å†™ Session Key å¹¶ç‚¹ä¿å­˜åå¯å¼€å§‹å¯¹è¯</small></div>';
    resetDTokenInfo();
  }
}

function closeDetail() {
  activeTaskId = null;
  dChatStreaming = false;
  document.getElementById('detailPanel').classList.remove('open');
  document.getElementById('detailOverlay').classList.remove('open');
}

function renderDFiles(files) {
  const list = document.getElementById('dFilesList');
  const cnt = document.getElementById('dFilesCount');
  if (cnt) cnt.textContent = files.length ? `(${files.length} ä¸ªæ–‡ä»¶)` : '';
  list.innerHTML = files.length ? files.map((f, i) => `
    <div class="dfile-item">
      <span class="dfile-name" title="${escHtml(f)}">ğŸ“„ ${escHtml(f)}</span>
      <button class="icon-btn del sm" onclick="removeDFile(${i})" title="ç§»é™¤å…³è”">âœ•</button>
    </div>
  `).join('') : '<div style="color:var(--text2);font-size:11px;padding:4px">æš‚æ— å…³è”æ–‡ä»¶</div>';
}

function removeDFile(idx) {
  const t = tasks.find(x => x.id === activeTaskId);
  if (!t) return;
  t.files = t.files || [];
  t.files.splice(idx, 1);
  renderDFiles(t.files);
  // Auto-save files
  fetch(`${TAPI}/tasks/${activeTaskId}`, { method:'PATCH', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ files: t.files }) });
}

async function addDFile() {
  const p = prompt('è¯·è¾“å…¥æ–‡ä»¶ç›¸å¯¹è·¯å¾„ï¼ˆç›¸å¯¹äº workspaceï¼Œå¦‚ memory/2026-02-18.mdï¼‰ï¼š');
  if (!p || !p.trim()) return;
  const t = tasks.find(x => x.id === activeTaskId);
  if (!t) return;
  if (!t.files) t.files = [];
  const trimmed = p.trim();
  if (!t.files.includes(trimmed)) {
    t.files.push(trimmed);
    renderDFiles(t.files);
    await fetch(`${TAPI}/tasks/${activeTaskId}`, { method:'PATCH', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ files: t.files }) });
  }
}

async function handleDFileUpload(event) {
  const t = tasks.find(x => x.id === activeTaskId);
  if (!t) return;
  if (!t.files) t.files = [];
  const files = Array.from(event.target.files);
  for (const f of files) {
    // Store as workspace-relative path with a special prefix to indicate it's a local upload
    const relPath = `uploads/${f.name}`;
    if (!t.files.includes(relPath)) {
      t.files.push(relPath);
      // Also add to pending chat files so user can optionally send content
      if (!pendingDChatFiles.includes(relPath)) pendingDChatFiles.push(relPath);
    }
  }
  renderDFiles(t.files);
  renderDChatFileChips();
  // Save
  await fetch(`${TAPI}/tasks/${activeTaskId}`, { method:'PATCH', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ files: t.files }) });
  // Reset input
  event.target.value = '';
}

// File picker for dchat (adds to pending files for this message)
async function dchatPickFile() {
  // Create a temporary file input
  const inp = document.createElement('input');
  inp.type = 'file';
  inp.multiple = true;
  inp.onchange = async (e) => {
    const t = tasks.find(x => x.id === activeTaskId);
    const files = Array.from(e.target.files);
    for (const f of files) {
      const relPath = `uploads/${f.name}`;
      if (!pendingDChatFiles.includes(relPath)) pendingDChatFiles.push(relPath);
      // Also add to task files[]
      if (t && !t.files) t.files = [];
      if (t && !t.files.includes(relPath)) {
        t.files.push(relPath);
        renderDFiles(t.files);
        fetch(`${TAPI}/tasks/${activeTaskId}`, { method:'PATCH', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ files: t.files }) });
      }
    }
    renderDChatFileChips();
  };
  inp.click();
}

function renderDChatFileChips() {
  const chips = document.getElementById('dChatFileChips');
  if (!chips) return;
  chips.innerHTML = pendingDChatFiles.map((f, i) => `
    <div class="dchat-file-chip">
      ğŸ“„ ${f.split('/').pop()}
      <button onclick="removePendingFile(${i})">âœ•</button>
    </div>
  `).join('');
  chips.style.display = pendingDChatFiles.length ? 'flex' : 'none';
}

function removePendingFile(idx) {
  pendingDChatFiles.splice(idx, 1);
  renderDChatFileChips();
}

async function loadDChat(key) {
  const container = document.getElementById('dChatMsgs');
  try {
    const r = await fetch(`${TAPI}/sessions/${encodeURIComponent(key)}`, {
      headers: { Authorization: `Bearer ${getToken()}` }
    });
    const d = await r.json();
    const msgs = d.messages || [];
    container.innerHTML = msgs.length ? msgs.map(m => {
      const role = m.role === 'user' ? 'user' : 'assistant';
      const label = m.role === 'user' ? 'ä½ ' : 'Claude';
      const content = Array.isArray(m.content)
        ? m.content.map(c => c.text || c.content || '').join('\n')
        : (m.content || '');
      return `<div class="msg ${role}">
        <div class="role">${label}</div>
        <div class="body">${escHtml(content)}</div>
      </div>`;
    }).join('') : '<div style="color:var(--text2);font-size:11px;text-align:center;padding:20px">ğŸ’¬ æš‚æ— å¯¹è¯è®°å½•</div>';
    container.scrollTop = container.scrollHeight;
  } catch (e) {
    container.innerHTML = `<div style="color:var(--red);font-size:11px;padding:10px">âŒ åŠ è½½å¤±è´¥: ${escHtml(e.message)}</div>`;
  }
}

async function updateDSessionStats(key) {
  // Try from cache first
  let s = sessionCache.find(x => (x.key === key || x.sessionKey === key));
  if (!s) {
    try {
      const r = await fetch(`${TAPI}/openclaw/sessions`, { headers: { Authorization: `Bearer ${getToken()}` } });
      const d = await r.json();
      const sessions = d.sessions || d || [];
      s = sessions.find(x => (x.key === key || x.sessionKey === key));
    } catch (e) {}
  }
  if (s) {
    const used = s.totalTokens || 0, ctx = s.contextTokens || 200000;
    const pct = Math.min(Math.round(used / ctx * 100), 100);
    document.getElementById('dTokenLbl').textContent = `Token ç”¨é‡: ${(used / 1000).toFixed(1)}k / ${(ctx / 1000).toFixed(0)}k`;
    document.getElementById('dTokenPct').textContent = `${pct}%`;
    const bar = document.getElementById('dTokenBar');
    bar.style.width = `${pct}%`;
    bar.className = `prog-fill ${pct > 90 ? 'err' : pct > 70 ? 'warn' : ''}`;
  }
}

function resetDTokenInfo() {
  document.getElementById('dTokenLbl').textContent = 'Token ç”¨é‡: -';
  document.getElementById('dTokenPct').textContent = '-';
  document.getElementById('dTokenBar').style.width = '0%';
}

function autoResizeDChat(el) { el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,80)+'px'; }

async function sendDChat() {
  const inp = document.getElementById('dChatInput');
  let text = inp.value.trim();
  const key = document.getElementById('dSessionKey').value.trim();
  if (dChatStreaming) return;
  if (!key) {
    alert('è¯·å…ˆå¡«å†™ Session Keyï¼ˆåœ¨åŸºæœ¬ä¿¡æ¯ä¸­ç‚¹"è‡ªåŠ¨"ç”Ÿæˆï¼Œç„¶åä¿å­˜ï¼‰');
    return;
  }
  
  // Append pending files info
  if (pendingDChatFiles.length > 0) {
    const fileList = pendingDChatFiles.map(f => `- ${f}`).join('\n');
    text = text ? `${text}\n\n[å…³è”æ–‡ä»¶]\n${fileList}` : `[å…³è”æ–‡ä»¶]\n${fileList}`;
  }
  if (!text) return;

  const mArea = document.getElementById('dChatMsgs');
  // Remove empty state message
  if (mArea.querySelector('div[style]')) {
    const emptyEl = mArea.querySelector('div[style*="text-align:center"]');
    if (emptyEl) emptyEl.remove();
  }

  const userMsg = document.createElement('div');
  userMsg.className = 'msg user';
  userMsg.innerHTML = `<div class="role">ä½ </div><div class="body">${escHtml(inp.value.trim())}${pendingDChatFiles.length ? `<br><small style="color:var(--accent);opacity:.7">ğŸ“ ${pendingDChatFiles.length} ä¸ªæ–‡ä»¶</small>` : ''}</div>`;
  mArea.appendChild(userMsg);
  mArea.scrollTop = mArea.scrollHeight;
  inp.value = '';
  inp.style.height = 'auto';
  
  // Clear pending files
  pendingDChatFiles = [];
  renderDChatFileChips();

  // Show typing indicator
  const typingEl = document.createElement('div');
  typingEl.id = 'dTyping';
  typingEl.className = 'msg assistant';
  typingEl.innerHTML = '<div class="role">Claude</div><div class="typing"><span></span><span></span><span></span></div>';
  mArea.appendChild(typingEl);
  mArea.scrollTop = mArea.scrollHeight;

  dChatStreaming = true;
  const sendBtn = document.getElementById('dSendBtn');
  if (sendBtn) sendBtn.disabled = true;

  try {
    // Use Gateway streaming for task sessions
    const resp = await fetch(`${GW}/v1/chat/completions`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${getToken()}`,
        'x-openclaw-session-key': key
      },
      body: JSON.stringify({ model: 'openclaw:main', stream: true, messages: [{ role: 'user', content: text }] })
    });
    
    typingEl.remove();
    
    if (!resp.ok) {
      const errText = await resp.text();
      const errEl = document.createElement('div');
      errEl.className = 'msg assistant';
      errEl.innerHTML = `<div class="role">Claude</div><div class="body" style="color:var(--red)">âŒ é”™è¯¯ ${resp.status}: ${escHtml(errText)}</div>`;
      mArea.appendChild(errEl);
    } else {
      const aiMsg = document.createElement('div');
      aiMsg.className = 'msg assistant';
      aiMsg.innerHTML = '<div class="role">Claude</div><div class="body"></div>';
      mArea.appendChild(aiMsg);
      const bodyEl = aiMsg.querySelector('.body');

      const reader = resp.body.getReader(), dec = new TextDecoder();
      let buf = '';
      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        buf += dec.decode(value, { stream: true });
        const lines = buf.split('\n'); buf = lines.pop();
        for (const line of lines) {
          if (!line.startsWith('data: ')) continue;
          const d = line.slice(6).trim();
          if (d === '[DONE]') break;
          try {
            const j = JSON.parse(d);
            const c = j.choices?.[0]?.delta?.content;
            if (c) { bodyEl.textContent += c; mArea.scrollTop = mArea.scrollHeight; }
          } catch {}
        }
      }
    }
  } catch (e) {
    typingEl.remove();
    const errEl = document.createElement('div');
    errEl.className = 'msg assistant';
    errEl.innerHTML = `<div class="role">Claude</div><div class="body" style="color:var(--red)">âŒ è¿æ¥å¤±è´¥: ${escHtml(e.message)}</div>`;
    mArea.appendChild(errEl);
  } finally {
    dChatStreaming = false;
    if (sendBtn) sendBtn.disabled = false;
    mArea.scrollTop = mArea.scrollHeight;
  }
}

function dChatKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendDChat(); }
}

function generateSessionKey() {
  const id = activeTaskId;
  const title = document.getElementById('dTitle').value
    .toLowerCase()
    .replace(/[\u4e00-\u9fa5]/g, '') // remove Chinese chars
    .replace(/[^\w\s-]/g, '')
    .replace(/\s+/g, '-')
    .replace(/-+/g, '-')
    .trim()
    .slice(0, 20) || id;
  document.getElementById('dSessionKey').value = `task:${id}:${title}`;
}

async function saveDetail() {
  const t = tasks.find(x => x.id === activeTaskId);
  if (!t) return;

  const proj = document.getElementById('dProject').value;
  if (proj === '__new__') {
    const n = prompt('æ–°é¡¹ç›®åç§°ï¼š');
    if (!n) return;
    await fetch(`${TAPI}/projects`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: n }) });
    document.getElementById('dProject').innerHTML += `<option value="${n}" selected>${n}</option>`;
    return saveDetail();
  }

  const newSessionKey = document.getElementById('dSessionKey').value.trim() || null;
  const body = {
    title: document.getElementById('dTitle').value.trim(),
    description: document.getElementById('dDesc').value.trim(),
    project: proj,
    priority: document.getElementById('dPri').value,
    sessionKey: newSessionKey,
    files: t.files || []
  };

  const r = await fetch(`${TAPI}/tasks/${activeTaskId}`, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  if (r.ok) {
    document.getElementById('dTitleH').textContent = body.title;
    // If new session key added, reload chat
    if (newSessionKey && newSessionKey !== t.sessionKey) {
      document.getElementById('dChatStatus').textContent = `[${newSessionKey}]`;
      loadDChat(newSessionKey);
      updateDSessionStats(newSessionKey);
    }
    // Visual feedback
    const saveBtn = document.querySelector('.detail-hdr .btn.sm');
    if (saveBtn) {
      const orig = saveBtn.textContent;
      saveBtn.textContent = 'âœ“ å·²ä¿å­˜';
      setTimeout(() => { saveBtn.textContent = orig; }, 1500);
    }
  }
}

// â”€â”€ Modal â”€â”€
function openModal(id){
  editId=id||null;
  document.getElementById('modalTitle').textContent=id?'ç¼–è¾‘ä»»åŠ¡':'æ–°å»ºä»»åŠ¡';
  if(id){ const t=tasks.find(x=>x.id===id); document.getElementById('fTitle').value=t.title; document.getElementById('fDesc').value=t.description; document.getElementById('fProject').value=t.project; document.getElementById('fPri').value=t.priority; document.getElementById('fStatus').value=t.status; document.getElementById('fDue').value=t.dueDate?t.dueDate.split('T')[0]:''; document.getElementById('fTags').value=t.tags.join(', '); }
  else{ ['fTitle','fDesc','fTags'].forEach(id=>document.getElementById(id).value=''); document.getElementById('fPri').value='medium'; document.getElementById('fStatus').value='todo'; document.getElementById('fDue').value=''; }
  document.getElementById('modalBg').classList.add('open');
  setTimeout(()=>document.getElementById('fTitle').focus(),50);
}
function editTask(id){ openModal(id); }
function closeModal(){ document.getElementById('modalBg').classList.remove('open'); editId=null; }
function closeMBg(e){ if(e.target===document.getElementById('modalBg'))closeModal(); }

async function saveTask(){
  const proj=document.getElementById('fProject').value;
  if(proj==='__new__'){ const n=prompt('æ–°é¡¹ç›®åç§°ï¼š'); if(!n)return; await fetch(`${TAPI}/projects`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:n})}); document.getElementById('fProject').value=n; return saveTask(); }
  const note = document.getElementById('fContextNote').value.trim();
  const body={
    title:document.getElementById('fTitle').value.trim(),
    description:document.getElementById('fDesc').value.trim(),
    project:proj,
    priority:document.getElementById('fPri').value,
    status:document.getElementById('fStatus').value,
    dueDate:document.getElementById('fDue').value||null,
    tags:document.getElementById('fTags').value.split(',').map(s=>s.trim()).filter(Boolean),
    contextNote: note,
    files: []
  };
  if(!body.title){alert('æ ‡é¢˜ä¸èƒ½ä¸ºç©º');return;}

  if(editId) {
    await fetch(`${TAPI}/tasks/${editId}`,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  } else {
    // New task: if has contextNote, auto-gen sessionKey
    const r = await fetch(`${TAPI}/tasks`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const newTask = await r.json();
    if (note && newTask.id) {
      const sKey = `task:${newTask.id}`;
      // Update task with sessionKey
      await fetch(`${TAPI}/tasks/${newTask.id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sessionKey: sKey })
      });
      // Send initial message
      await fetch(`${TAPI}/sessions/send`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${getToken()}` },
        body: JSON.stringify({ sessionKey: sKey, message: note })
      });
    }
  }
  closeModal();
}

document.addEventListener('keydown',e=>{ if(e.key==='Escape')closeModal(); });

connectWS();
</script>
</body>
</html>
